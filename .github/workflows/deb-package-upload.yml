---

name: Build and Upload DEBS

on:
  push:
    branches:
      - main
    tags:
      - '**'
  pull_request:
    branches:
      - '**'
  workflow_dispatch:

jobs:
  build-upload-debs:
    runs-on: ubuntu-latest

    env:
      SIGNALWIRE_USER: ${{ secrets.SIGNALWIRE_USER }}
      SIGNALWIRE_PASSWORD: ${{ secrets.SIGNALWIRE_PASSWORD }}

    strategy:
      matrix:
        debian: [bullseye, bookworm]

    container:
      image: debian:${{ matrix.debian }}

    steps:
      - uses: actions/checkout@v4

      - name: Export .env.debian variables to GITHUB_ENV
        shell: bash
        run: |
          if [ -f .env.debian ]; then
            while IFS='=' read -r key value; do
              # Skip comments and empty lines
              [[ -z "$key" || "$key" =~ ^[[:space:]]*# ]] && continue
              # Remove surrounding quotes and trim whitespace
              clean_value=$(echo "$value" | sed -e 's/^"//' -e 's/"$//' -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
              # Only export non-empty keys
              if [[ -n "$key" && -n "$clean_value" ]]; then
                echo "$key=$clean_value" >> $GITHUB_ENV
              fi
            done < <(grep -v '^#' .env.debian)
          fi

      - name: Install build dependencies
        run: |
          apt-get update
          apt-get install -y wget gnupg2 lsb-release devscripts build-essential fakeroot lintian dh-make debhelper pkg-config

      - name: Add Freeswitch repo
        run: |
          wget --http-user=${SIGNALWIRE_USER} --http-password=${SIGNALWIRE_PASSWORD} -O /usr/share/keyrings/signalwire-freeswitch-repo.gpg https://freeswitch.signalwire.com/repo/deb/debian-release/signalwire-freeswitch-repo.gpg
          echo "machine freeswitch.signalwire.com login ${SIGNALWIRE_USER} password ${SIGNALWIRE_PASSWORD}" > /etc/apt/auth.conf
          chmod 600 /etc/apt/auth.conf
          echo "deb [signed-by=/usr/share/keyrings/signalwire-freeswitch-repo.gpg] https://freeswitch.signalwire.com/repo/deb/debian-release/ `lsb_release -sc` main" > /etc/apt/sources.list.d/freeswitch.list
          echo "deb-src [signed-by=/usr/share/keyrings/signalwire-freeswitch-repo.gpg] https://freeswitch.signalwire.com/repo/deb/debian-release/ `lsb_release -sc` main" >> /etc/apt/sources.list.d/freeswitch.list
          apt-get update
          apt-get install -y libfreeswitch-dev

      - name: Prepare Environment for Build DEB package
        run: |
          mkdir -p $WORK_DIR/mod-free-amd
          mkdir -p $WORK_DIR/debian
          cp -r Makefile mod_free_amd.c $WORK_DIR/mod-free-amd/
          cp -r DEB/debian/* $WORK_DIR/debian/
          sed -i "s/_VERSION_/${VERSION}/; s/_RELEASE_/${RELEASE}/" $WORK_DIR/debian/changelog

      - name: Build DEB package
        run: |
          cd $WORK_DIR
          MODULES_DIR=${MOD_DIR} dpkg-buildpackage -us -uc -b

      - name: Create GitHub Release and upload RPMs
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ matrix.debian }}-${{ env.VERSION }}
          files: ../${{ env.WORK_DIR }}/*.deb
          overwrite_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
