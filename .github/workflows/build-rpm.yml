---

name: Build RPM (CentOS 7)

on:
  push:
    branches:
      - main
    tags:
      - '**'
  pull_request:
    branches:
      - '**'
  workflow_dispatch:

jobs:
  build-rpm-centos7:
    runs-on: ubuntu-latest

    env:
      SIGNALWIRE_USER: ${{ secrets.SIGNALWIRE_USER }}
      SIGNALWIRE_PASSWORD: ${{ secrets.SIGNALWIRE_PASSWORD }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Load .env into workflow
        run: |
          if [ -f .env ]; then
            set -o allexport
            source .env
            set +o allexport
            echo "VERSION=${VERSION}" >> $GITHUB_ENV
            echo "RELEASE=${RELEASE}" >> $GITHUB_ENV
            echo "FS_USER=${FS_USER}" >> $GITHUB_ENV
            echo "FS_GROUP=${FS_GROUP}" >> $GITHUB_ENV
            echo "MOD_DIR=${MOD_DIR}" >> $GITHUB_ENV
            echo "WORKDIR=${WORKDIR}" >> $GITHUB_ENV
            echo "FREESWITCH_DEVEL_VERSION=${FREESWITCH_DEVEL_VERSION}" >> $GITHUB_ENV
          fi

      - name: Build Docker image
        run: |
          docker build \
            -f Dockerfile-centos7 \
            --build-arg SIGNALWIRE_USER=${SIGNALWIRE_USER} \
            --build-arg SIGNALWIRE_PASSWORD=${SIGNALWIRE_PASSWORD} \
            --build-arg VERSION=${VERSION} \
            --build-arg RELEASE=${RELEASE} \
            --build-arg FS_USER=${FS_USER} \
            --build-arg FS_GROUP=${FS_GROUP} \
            --build-arg MOD_DIR=${MOD_DIR} \
            --build-arg FREESWITCH_DEVEL_VERSION=${FREESWITCH_DEVEL_VERSION} \
            -t rpm-builder .

      - name: Create temporary output folder
        run: mkdir -p /tmp/rpms

      - name: Run Docker container to build RPMs
        run: |
          docker run --rm \
            -v /tmp/rpms:${WORK_DIR}/rpmbuild/RPMS \
            -env-file .env \
            rpm-builder

      - name: List generated RPMs
        run: ls -R /tmp/rpms

      - name: Create GitHub Release and upload RPMs
        uses: softprops/action-gh-release@v2
        with:
          files: /tmp/rpms/**/*.rpm
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
